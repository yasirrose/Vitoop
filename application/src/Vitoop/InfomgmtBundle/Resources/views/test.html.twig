<div>
<p>Chat</p>
<div id="chat">
    {% for message in conversation['conversation_data']['messages'] %}
        <li><b>{{ message['user']['username']}}</b>  at: {{ message['date']|date('Y-m-d - H:m:s') }}
            <p>{{ message['message'] }}</p>
            <hr>
        </li>
    {% endfor %}

</div>

    <input type="text" id="message"><br>
    <button type="button" id="button">Send</button>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.3/dist/sockjs.min.js" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/centrifugal/centrifuge-js/2.3.0/dist/centrifuge.min.js"></script>

    <script>
        /* Web sockets get messages */
        window.onload = function() {
            //var centrifuge = new Centrifuge('https://centrifugo2.herokuapp.com/connection/sockjs');
            var centrifuge = new Centrifuge("https://centrifugal.vitoop.de:8000/connection/sockjs");
            var element = document.getElementById('chat');
            var text;

            centrifuge.setToken({{ token }});

            centrifuge.subscribe([{{ channel }}], function(message) {
                let node = document.createElement("li");
                text = document.createTextNode(message.data);
                node.appendChild(text);
                element.appendChild(node);
            });

                centrifuge.connect();

            /* Send messages */
            $('#button').click(function () {
                let route = window.location.href.split("/");
                let id = route[route.length-1];
                let message = $('#message').val();
                $.ajax({
                    method: "POST",
                    url: "/api/conversation/" + id + "/send",
                    data: { 'message': message }
                })
                    .done(function( msg ) {
                        centrifuge.publish('news', message).then(function(res) {
                            console.log('successfully published');
                        })
                    });
            })
        }
    </script>
</div>

<script
        src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous"></script>